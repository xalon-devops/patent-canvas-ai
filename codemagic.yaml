workflows:

  android-release:
    name: Android Release Build
    max_build_duration: 60
    instance_type: linux_x2

    environment:
      java: 17
      node: 20
      vars:
        ANDROID_KEYSTORE_PASSWORD: $ANDROID_KEYSTORE_PASSWORD
        ANDROID_KEY_ALIAS: $ANDROID_KEY_ALIAS
        ANDROID_KEY_PASSWORD: $ANDROID_KEY_PASSWORD
      android_signing:
        - appship_keystore

    scripts:
      - name: Download and extract project
        script: |
          echo "Downloading project from: $APP_ZIP_URL"
          curl -L -o project.zip "$APP_ZIP_URL"
          unzip -o project.zip -d ./app
          cd app
          if [ -d "capacitor-project" ]; then
            mv capacitor-project/* .
            rm -rf capacitor-project
          fi
          ls -la

      - name: Install dependencies
        script: |
          cd app
          npm ci || npm install

      - name: Add and sync Capacitor
        script: |
          cd app
          rm -rf android
          npx cap add android
          npx cap sync android

      - name: Build Android
        script: |
          cd app/android
          chmod +x gradlew
          ./gradlew assembleRelease

    artifacts:
      - app/android/app/build/outputs/**/*.apk
      - app/android/app/build/outputs/**/*.aab

    publishing:
      scripts:
        - name: Notify build result
          script: |
            if [ "$CM_BUILD_STEP_STATUS" == "success" ]; then
              STATUS="finished"
            else
              STATUS="failed"
            fi
            curl -X POST "$SUPABASE_URL/functions/v1/codemagic-webhook" \
              -H "Content-Type: application/json" \
              -d "{
                \"buildId\": \"$CM_BUILD_ID\",
                \"status\": \"$STATUS\",
                \"platform\": \"android\",
                \"workflowId\": \"android-release\",
                \"environment\": {\"variables\": {\"USER_APP_ID\": \"$USER_APP_ID\"}},
                \"artefacts\": [{\"url\": \"$CM_ARTIFACT_LINKS\", \"type\": \"apk\"}],
                \"finishedAt\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }"

  ios-release:
    name: iOS Release Build
    max_build_duration: 90
    instance_type: mac_mini_m2

    environment:
      xcode: latest
      node: 20
      cocoapods: default

    scripts:
      - name: Download and extract project
        script: |
          echo "Downloading project from: $APP_ZIP_URL"
          curl -L -o project.zip "$APP_ZIP_URL"
          unzip -o project.zip -d ./app
          cd app
          if [ -d "capacitor-project" ]; then
            mv capacitor-project/* .
            rm -rf capacitor-project
          fi
          ls -la

      - name: Install dependencies
        script: |
          cd app
          npm ci || npm install

      - name: Add and sync Capacitor
        script: |
          cd app
          rm -rf ios
          npx cap add ios
          npx cap sync ios
          cd ios/App
          sed -i '' "s/PRODUCT_BUNDLE_IDENTIFIER = .*/PRODUCT_BUNDLE_IDENTIFIER = ${BUNDLE_ID};/g" App.xcodeproj/project.pbxproj
          sed -i '' "s/DEVELOPMENT_TEAM = .*/DEVELOPMENT_TEAM = ${TEAM_ID};/g" App.xcodeproj/project.pbxproj

      - name: Install CocoaPods
        script: |
          cd app/ios/App
          pod install

      - name: Set up code signing
        script: |
          keychain initialize
          # Decode App Store Connect API key
          printf '%s' "$APP_STORE_CONNECT_KEY_CONTENT" | base64 -D > /tmp/AuthKey.p8
          # Auto-generate certificate signing key if not provided
          if [ -z "$CM_CERTIFICATE_PRIVATE_KEY" ]; then
            openssl genrsa -out /tmp/cert_key.pem 2048
          else
            echo "$CM_CERTIFICATE_PRIVATE_KEY" > /tmp/cert_key.pem
          fi
          app-store-connect fetch-signing-files "$BUNDLE_ID" \
            --type IOS_APP_STORE \
            --key-id "$APP_STORE_CONNECT_KEY_ID" \
            --issuer-id "$APP_STORE_CONNECT_ISSUER_ID" \
            --private-key "$(cat /tmp/AuthKey.p8)" \
            --certificate-key /tmp/cert_key.pem \
            --create
          keychain add-certificates
          cd app/ios/App
          xcode-project use-profiles

      - name: Build iOS
        script: |
          cd app/ios/App
          xcode-project build-ipa \
            --workspace App.xcworkspace \
            --scheme App

    artifacts:
      - app/ios/App/build/ios/ipa/*.ipa
      - app/ios/App/**/*.xcarchive

    publishing:
      scripts:
        - name: Notify build result
          script: |
            if [ "$CM_BUILD_STEP_STATUS" == "success" ]; then
              STATUS="finished"
            else
              STATUS="failed"
            fi
            curl -X POST "$SUPABASE_URL/functions/v1/codemagic-webhook" \
              -H "Content-Type: application/json" \
              -d "{
                \"buildId\": \"$CM_BUILD_ID\",
                \"status\": \"$STATUS\",
                \"platform\": \"ios\",
                \"workflowId\": \"ios-release\",
                \"environment\": {\"variables\": {\"USER_APP_ID\": \"$USER_APP_ID\"}},
                \"artefacts\": [{\"url\": \"$CM_ARTIFACT_LINKS\", \"type\": \"ipa\"}],
                \"finishedAt\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }"
